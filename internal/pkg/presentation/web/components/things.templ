package components

import (
	"fmt"
	"github.com/diwise/diwise-web/internal/pkg/presentation/locale"
	"slices"
	"strings"
	"time"
)

type ThingsListViewModel struct {
	Things  []ThingViewModel
	Pageing PagingViewModel
	MapView bool
}

type MeasurementViewModel struct {
	ID          string    `json:"id"`
	Timestamp   time.Time `json:"timestamp"`
	Urn         string    `json:"urn"`
	BoolValue   *bool     `json:"vb,omitempty"`
	StringValue string    `json:"vs,omitempty"`
	Unit        string    `json:"unit,omitempty"`
	Value       *float64  `json:"v,omitempty"`
}

type ThingViewModel struct {
	ThingID      string
	ID           string
	Type         string
	Latitude     float64
	Longitude    float64
	Tenant       string
	Measurements []MeasurementViewModel
}

templ ThingsTable(l10n locale.Localizer, model ThingsListViewModel) {
	<table class="table-auto min-w-full text-sm text-left dark:bg-content-background dark:text-white">
		<thead class="border-b border-dark-primary dark:border-white">
			<tr>
				<th class="px-6 py-3">{ l10n.Get("id") }</th>
				<th class="px-6 py-3">{ l10n.Get("type") }</th>
				<th class="px-6 py-3">{ l10n.Get("status") }</th>
			</tr>
		</thead>
		<tbody>
			@ThingsRows(l10n, model.Things)
		</tbody>
		<tfoot>
			<tr>
				<td colspan="3">
					@Paging(l10n, model.Pageing)
				</td>
			</tr>
		</tfoot>
	</table>
}

templ ThingsRows(l10n locale.Localizer, things []ThingViewModel) {
	for _, thing := range things {
		@ThingRow(l10n, thing)
	}
}

templ ThingRow(l10n locale.Localizer, thing ThingViewModel) {
	<tr
		class="border-b border-divider-gray border-opacity-70 hover:bg-background-100 dark:border-white dark:bg-opacity-20 hover:cursor-pointer"
		hx-get={ string(templ.SafeURL(fmt.Sprintf("/components/things/details?id=%s", thing.ThingID))) }
		hx-target="#things-view"
		hx-push-url={ string(templ.SafeURL(fmt.Sprintf("/things/%s", thing.ThingID))) }
		hx-trigger="click"
	>
		<td class="px-6 py-3"><span class="font-bold">{ thing.ID }</span></td>
		<td class="px-6 py-3">{ thing.Type }</td>
		<td class="px-6 py-3">
			@ThingStatusCell(l10n, thing)
		</td>
	</tr>
}

templ TableOrMapButtons(l10n locale.Localizer) {
	<div class="w-full h-12 justify-between items-center inline-flex">
		<div class="inline-flex justify-start items-center gap-[34px] dark:text-white">
			<div class="flex items-center flex-[1_0_0] gap-6">
				@CheckboxList(l10n.Get("Typ")) {
					for _, t := range []string{"combinedsewageoverflow", "wastecontainer", "sewer", "sewagepumpingstation"} {
						@CheckboxOption("type", t, templ.Attributes{
							"hx-get":    string(templ.SafeURL("/components/things/list")),
							"hx-target": "#tableOrMap",
						})
					}
				}
			</div>
		</div>
		@TableOrMap(l10n, "/components/things/list")
	</div>
}

templ ThingsList(l10n locale.Localizer, model ThingsListViewModel) {
	<div class="flex flex-col items-start gap-14 flex-[1_0_0] py-8 w-full" id="things-view">
		<div class="flex flex-col items-start gap-6 self-stretch w-full px-8">
			<div class="flex items-center w-full justify-between">
				<h1 class="dark:text-white text-2xl font-bold font-heading leading-loose">{ l10n.Get("things") }</h1>
				<div class="flex items-center text-white dark:text-dark-primary font-bold">
					<button class="flex justify-center items-center gap-2 px-4 py-2 bg-primary-surface hover:bg-primary-surface-hover dark:bg-primary-surface-dark dark:hover:bg-primary-surface-dark-hover rounded-xl cursor-pointer" hx-get="/components/things" hx-trigger="click">{ l10n.Get("addthing") }</button>
				</div>
			</div>
		</div>
		<div class="h-px border-t border-divider-gray w-full dark:border-divider-white"></div>
		<div class="flex px-8 flex-col items-start self-stretch gap-10">
			@TableOrMapButtons(l10n)
			@DataList(l10n, ThingsTable(l10n, model), ThingsMap(l10n, model), model.MapView)
		</div>
	</div>
}

func ThingsMap(l10n locale.Localizer, model ThingsListViewModel) templ.Component {
	if !model.MapView {
		return templ.NopComponent
	}
	return Map(newMapData(62.3908, 17.3069), thingsToMapFeature(model))
}

func thingsToMapFeature(model ThingsListViewModel) FeatureCollection {
	features := make([]Feature, 0, len(model.Things))

	for _, thing := range model.Things {
		if thing.Latitude == 0 || thing.Longitude == 0 {
			continue
		}
		feature := NewFeature(NewPoint(thing.Latitude, thing.Longitude))
		feature.AddProperty("type", strings.ToLower(thing.Type))
		feature.AddProperty("desc", thing.ThingID)
		features = append(features, feature)
	}

	return NewFeatureCollection(features)
}

func ThingStatusCell(l10n locale.Localizer, thing ThingViewModel) templ.Component {
	switch strings.ToLower(thing.Type) {
	case "combinedsewageoverflow":
		return CombinedSewageOverflowCell(l10n, thing)
	case "wastecontainer":
		return WasteContainerCell(l10n, thing)
	case "sewer":
		return SewerCell(l10n, thing)
	case "sewagepumpingstation":
		return SewagePumpingstationCell(l10n, thing)
	default:
		return templ.NopComponent
	}
}

func CombinedSewageOverflowCell(l10n locale.Localizer, thing ThingViewModel) templ.Component {
	i := slices.IndexFunc(thing.Measurements, func(m MeasurementViewModel) bool {
		return strings.HasSuffix(m.ID, "3350/5850") // Stopwatch/OnOff
	})

	if i == -1 {
		return templ.NopComponent
	}

	state := l10n.Get("Ok")
	if *thing.Measurements[i].BoolValue {
		state = l10n.Get("Br√§ddar")
	}

	return Text(state)
}

func SewagePumpingstationCell(l10n locale.Localizer, thing ThingViewModel) templ.Component {
	i := slices.IndexFunc(thing.Measurements, func(m MeasurementViewModel) bool {
		return strings.HasSuffix(m.ID, "3200/5500") // Digital Input/Digital Input State
	})

	if i == -1 || thing.Measurements[i].BoolValue == nil {
		return templ.NopComponent
	}

	state := "Ok"
	if *thing.Measurements[i].BoolValue {
		state = l10n.Get("Pumpar")
	}

	return Text(state)
}

func SewerCell(l10n locale.Localizer, thing ThingViewModel) templ.Component {
	i := slices.IndexFunc(thing.Measurements, func(m MeasurementViewModel) bool {
		return strings.HasSuffix(m.ID, "3330/5700") // Distance/Sensor value
	})

	if i == -1 || thing.Measurements[i].Value == nil {
		return templ.NopComponent
	}

	return Text(fmt.Sprintf("%.2f%s", *thing.Measurements[i].Value, thing.Measurements[i].Unit))
}

func WasteContainerCell(l10n locale.Localizer, t ThingViewModel) templ.Component {
	i := slices.IndexFunc(t.Measurements, func(m MeasurementViewModel) bool {
		return strings.HasSuffix(m.ID, "3435/2") // Filling level/Actual filling percentage
	})

	if i == -1 || t.Measurements[i].Value == nil {
		return templ.NopComponent
	}

	return progressBar(fmt.Sprintf("%0.f", *t.Measurements[i].Value))

	//return ProgressBar(fmt.Sprintf("pb_%s", t.ID), int(*t.Measurements[i].Value))
}
